name: Build & Deploy phuc.wtf

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  init:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: jphuc96/phuc.wtf
    
  build-docker:
    name: build docker image
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag ${{ jobs.init.env.IMAGE_NAME }}:$GITHUB_SHA
    - name: Login to docker.io
      run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
    - name: Push Image
      run: docker push ${{ jobs.init.env.IMAGE_NAME }}:$GITHUB_SHA
  
  deploy-kubernetes:
    name: deploy to cluster
    needs: [build-docker]
    runs-on: ubuntu-latest
    steps:
    - uses: danielr1996/kubectl-action@1.0.0
      name: Deploy
      with:
        kubeconfig: ${{ secrets.KUBE_CONFIG_DATA }}
        args: set -n phucwtf image --record deployment/phucwtf phucwtf=${{ jobs.init.env.IMAGE_NAME }}:$GITHUB_SHA
    - uses: danielr1996/kubectl-action@1.0.0
      name: Rollout
      with:
        kubeconfig: ${{ secrets.KUBE_CONFIG_DATA }}
        args: rollout -n phucwtf status deployment/phucwtf
  
#     - uses: actions/checkout@master
#     - name: deploy to cluster
#       uses: steebchen/kubectl@master
#       env:
#         KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
#       with:
#         args: set -n phucwtf image --record deployment/phucwtf phucwtf=reg.phuc.wtf/phuc.wtf:$GITHUB_SHA
#     - name: verify deployment
#       uses: steebchen/kubectl@master
#       env:
#         KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
#         KUBECTL_VERSION: "1.17"
#       with:
#         args: '"rollout -n phucwtf status deployment/phucwtf"'
